package controllers;

import javafx.beans.property.SimpleFloatProperty;
import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.stage.Stage;
import models.Contrat;
import services.ContratService;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static models.Contrat.convertToDateFormat;

public class AjouterContrat {

    @FXML
    private Button btnAjouterContrat, btnAnnuler, btnSupprimerContrat, btnModifierContrat, btnActualiserContrat;

    @FXML
    private TextField tx_contrat_titre, tx_contrat_montant, tx_contrat_sponsor;

    @FXML
    private DatePicker dp_date_debut, dp_date_fin;

    @FXML
    private TableView<Contrat> tableViewContrats;

    @FXML
    private TableColumn<Contrat, String> colTitre, colSponsor;

    @FXML
    private TableColumn<Contrat, String> colDateDebut, colDateFin;

    @FXML
    private TableColumn<Contrat, Float> colMontant;

    private final ContratService contratService = new ContratService();
    private ObservableList<Contrat> contratList = FXCollections.observableArrayList();
    private Contrat selectedContrat = null;

    @FXML
    private void ajouterContrat(ActionEvent event) {
        String titre = tx_contrat_titre.getText().trim();
        String sponsor = tx_contrat_sponsor.getText();
        String dateDebut = (dp_date_debut.getValue() != null) ? dp_date_debut.getValue().toString() : "";
        String dateFin = (dp_date_fin.getValue() != null) ? dp_date_fin.getValue().toString() : "";
        String montantStr = tx_contrat_montant.getText().trim();

        if (titre.isEmpty() || sponsor == null || dateDebut.isEmpty() || dateFin.isEmpty() || montantStr.isEmpty()) {
            showAlert(Alert.AlertType.ERROR, "Erreur", "Veuillez remplir tous les champs !");
            return;
        }

        dateDebut = convertToDateFormat(dateDebut);
        dateFin = convertToDateFormat(dateFin);

        if (dateDebut == null || dateFin == null) {
            showAlert(Alert.AlertType.ERROR, "Format de date incorrect", "La date doit avoir le format AAAA/MM/JJ !");
            return;
        }

        float montant;
        try {
            montant = Float.parseFloat(montantStr);
        } catch (NumberFormatException e) {
            showAlert(Alert.AlertType.ERROR, "Erreur", "Le montant doit être un nombre valide !");
            return;
        }

        ContratService cs = new ContratService();
        cs.ajouter(new Contrat(Integer.parseInt(sponsor), titre, dateDebut, dateFin, montant));

        showAlert(Alert.AlertType.INFORMATION, "Succès", "Le contrat a été ajouté avec succès !");
        clearFields();
        goToAfficherContrats(event);
    }

    @FXML
    private void goToAfficherContrats(ActionEvent event) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/AfficherContrat.fxml"));
            Parent root = loader.load();
            Stage stage = (Stage) ((Node) event.getSource()).getScene().getWindow();
            stage.setScene(new Scene(root));
            stage.setTitle("Liste des Contrats");
            stage.show();
        } catch (IOException e) {
            showAlert(Alert.AlertType.ERROR, "Erreur", "Impossible de charger la page AfficherContrat.");
            e.printStackTrace();
        }
    }

    @FXML
    public void initialize() {
        colTitre.setCellValueFactory(cellData -> new SimpleStringProperty(cellData.getValue().getTitre()));
        colSponsor.setCellValueFactory(cellData -> new SimpleStringProperty(String.valueOf(cellData.getValue().getId_sponsor())));
        colDateDebut.setCellValueFactory(cellData -> new SimpleStringProperty(cellData.getValue().getDateDebut()));
        colDateFin.setCellValueFactory(cellData -> new SimpleStringProperty(cellData.getValue().getDateFin()));
        colMontant.setCellValueFactory(cellData -> new SimpleFloatProperty(cellData.getValue().getMontant()).asObject());

        tableViewContrats.setItems(contratList);
        loadContrats();

        btnAjouterContrat.setOnAction(this::ajouterContrat);
        btnAnnuler.setOnAction(event -> clearFields());
        btnSupprimerContrat.setOnAction(event -> handleSupprimer());
        btnActualiserContrat.setOnAction(event -> loadContrats());

        tableViewContrats.getSelectionModel().selectedItemProperty().addListener((obs, oldSelection, newSelection) -> {
            if (newSelection != null) {
                selectedContrat = newSelection;
                tx_contrat_titre.setText(selectedContrat.getTitre());
                tx_contrat_sponsor.setText(String.valueOf(selectedContrat.getId_sponsor()));
                dp_date_debut.setValue(java.time.LocalDate.parse(selectedContrat.getDateDebut()));
                dp_date_fin.setValue(java.time.LocalDate.parse(selectedContrat.getDateFin()));
                tx_contrat_montant.setText(String.valueOf(selectedContrat.getMontant()));
            }
        });
    }

    private void handleAjouterOuModifier() {
        String titre = tx_contrat_titre.getText(); // Get the title of the contract
        String sponsor = tx_contrat_sponsor.getText(); // Get the sponsor's ID
        String dateDebut = dp_date_debut.getValue() != null ? dp_date_debut.getValue().toString() : ""; // Get the start date
        String dateFin = dp_date_fin.getValue() != null ? dp_date_fin.getValue().toString() : ""; // Get the end date
        String montantStr = tx_contrat_montant.getText(); // Get the contract amount

        // Check if any of the fields are empty
        if (titre.isEmpty() || sponsor.isEmpty() || dateDebut.isEmpty() || dateFin.isEmpty() || montantStr.isEmpty()) {
            showAlert(Alert.AlertType.ERROR, "Erreur", "Tous les champs sont obligatoires !");
            return;
        }

        dateDebut = convertToDateFormat(dateDebut);
        dateFin = convertToDateFormat(dateFin);

        if (dateDebut == null || dateFin == null) {
            showAlert(Alert.AlertType.ERROR, "Format de date incorrect", "La date doit avoir le format AAAA/MM/JJ !");
            return;
        }

        // Convert the amount from String to Float
        float montant;
        try {
            montant = Float.parseFloat(montantStr);
        } catch (NumberFormatException e) {
            showAlert(Alert.AlertType.ERROR, "Erreur", "Le montant doit être un nombre valide !");
            return;
        }

        // If no contrat is selected, it's a new contract
        if (selectedContrat == null) {
            Contrat contrat = new Contrat(Integer.parseInt(sponsor), titre, dateDebut, dateFin, montant);
            contratService.ajouter(contrat); // Add the new contract
            contratList.add(contrat); // Add to the observable list
        } else {
            // If a contract is selected, update the contract
            selectedContrat.setTitre(titre);
            selectedContrat.setId_sponsor(Integer.parseInt(sponsor)); // Set the sponsor ID
            selectedContrat.setDateDebut(dateDebut);
            selectedContrat.setDateFin(dateFin);
            selectedContrat.setMontant(montant);
            contratService.modifier(selectedContrat); // Modify the existing contract
            loadContrats(); // Reload the contract list
        }

        clearFields(); // Clear the fields after operation
    }



    private void loadContrats() {
        contratList.clear();
        List<Contrat> contrats = new ArrayList<>();
        contrats = contratService.rechercher();
        contratList.addAll(contrats);
    }

    private void handleSupprimer() {
        Contrat selected = tableViewContrats.getSelectionModel().getSelectedItem();
        if (selected != null) {
            contratService.supprimer(selected);
            contratList.remove(selected);
        }
    }

    private void clearFields() {
        tx_contrat_titre.clear();
        tx_contrat_sponsor.clear();
        dp_date_debut.setValue(null);
        dp_date_fin.setValue(null);
        tx_contrat_montant.clear();
        selectedContrat = null;
    }

    private void showAlert(Alert.AlertType type, String title, String content) {
        Alert alert = new Alert(type);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(content);
        alert.showAndWait();
    }
}
